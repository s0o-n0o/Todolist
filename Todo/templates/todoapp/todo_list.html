{% extends 'todoapp/index.html' %}
{% load static %}
{% block title %}Todo一覧画面 {{block.super}}{% endblock%}
{% block content %}
    <header class ="p-1">
        <div class="d-flex justify-content-left">
            <a type="submit" class="ms-1 btn btn-primary" href="{% url 'TodoApp:add_todo' %}">+追加</a>    
            <div class="ms-3 dropdown">
                <a class="btn btn-primary dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                    並べ替え
                </a>
                <ul class="dropdown-menu">
                    <li><a type="submit" class="dropdown-item ms-1 btn btn-primary" href="{% url 'TodoApp:priority_sort' %}">優先度</a>    </li>
                    <li><a type="submit" class="dropdown-item ms-1 btn btn-primary" href="{% url 'TodoApp:priority_sort' %}">カテゴリー</a></li>
                    <li><a type="submit" class="dropdown-item ms-1 btn btn-primary" href="{% url 'TodoApp:priority_sort' %}">期限</a></li>
                </ul>
            </div>
            <form class="d-flex ms-2" method="GET" action="{% url 'TodoApp:search' %}"> 
                {% csrf_token%}
                <input class="form-control me-2" type="text" name="keyword" placeholder="CategorySearch" >
                <button class="btn btn-outline-primary" type="submit">Search</button>
            </form>
        </div>



    </header>
    <div class='mt-5'>
        {% if messages %}
            {% for message in messages %}
                <h3>{{message}}</h3>
            {% endfor%}
        {% endif %}
        {% for todo in todo_list %}
        <ul class="list-group">
            <li class="ms-2 list-group-item" > 
                <input class="form-check-input" type="checkbox" value={{todo.status}} id="todocheckbox" name="todocheckbox">
                <a href=" {% url 'TodoApp:update_todo' id=todo.id %}">
                {{todo.title}} </a>/ 
                期限: {{todo.deadline}} / 
                優先度: {{todo.priority}} /
                カテゴリー: {{todo.category}}
                <a href="{% url 'TodoApp:delete_todo' id=todo.id %}">
                <img src="{% static "img/trash.png" %}" height="20" width="40"></a>
            </li>
        </ul>
        {% endfor %}
    </div>
    {% block javascript %}
    <script>
    function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = jQuery.trim(cookies[i]);
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
                    }
                }
            }
        return cookieValue;
        }

    var csrftoken = getCookie('csrftoken');

    function csrfSafeMethod(method) {
        // these HTTP methods do not require CSRF protection
        return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }

    $.ajaxSetup({
        beforeSend: function (xhr, settings) {
        if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
            xhr.setRequestHeader("X-CSRFToken", csrftoken);
        }
        }
    });
    $('input[name="todocheckbox"]').change(function(){
        alert('checkbox is checked.');
        let todocheckbox= document.getElementById('todocheckbox');
        $.post( '{% url 'TodoApp:change_status' %}', 'todo_status=todocheckbox' );
    }
    </script>
    {% endblock %}
    
{% endblock %}
